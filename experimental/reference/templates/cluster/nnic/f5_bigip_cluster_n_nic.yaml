---
heat_template_version: 2016-04-08

# **********************************************************************************************************************
# TODO: Change how we iterate through ResourceGroup items when moving templates to Ocata version.
# There is a bug in repeat function that is only fixed in Ocata release. https://bugs.launchpad.net/heat/+bug/1629899
# So we're not able to use get_attr in the for_each, as shown below:
# repeat:
#   template:
#     port: <%port%>
#   for_each:
#     <%port%>: { get_attr: [bigip_nnic_handler, port_ids] }
# We can't use OS::Heat::Value as well, as it is only supported in Newton.
# As a workaround, we turn the list into a string, then split again, to force repeat function to recognize the list.
# **********************************************************************************************************************

description: This template deploys an f5 active-standby BIG-IP VE pair with dynamic number of NICs.

parameters:
  bigip_image:
    type: string
    label: f5 BIG-IP VE Image
    description: The BIG-IP VE image to be used on the compute instance.
    constraints:
      - custom_constraint: glance.image
  bigip_flavor:
    type: string
    label: f5 BIG-IP VE Flavor
    description: Type of instance (flavor) to be used for the VE.
    constraints:
      - custom_constraint: nova.flavor
  bigip_cluster_name:
    type: string
    label: f5 BIG-IP VE Device Group Name
  bigip_cluster_sync_type:
    type: string
    label: f5 BIG-IP VE Cluster Sync Type
    description: Is this a sync-failover or sync-only device group
    default: sync-failover
  bigip_cluster_auto_sync:
    type: boolean
    label: f5 BIG-IP VE Cluster AutoSync
    description: Should a clustered device auto synchronize config changes
    default: false
  bigip_cluster_save_on_auto_sync:
    type: boolean
    label: f5 BIG-IP VE Cluster Config Save on Auto Sync
    description: Should a clustered device save its configuration on automatic synchronization
    default: false
  use_config_drive:
    type: boolean
    label: Use Config Drive
    description: Use config drive to provide meta and user data.
    default: false
  f5_cloudlibs_tag:
    type: string
    label: f5 CloudLibs Tag
    description: Tag that determines version of f5 cloudlibs to use for provisioning. If specified, ensure that hashes are valid by either updating scripts/verifyHash or by providing a f5_cloudlibs_verify_hash_url_override value.
    default: v3.5.0
  f5_cloudlibs_url_override:
    type: string
    label: f5 cloud-libs URL Override
    description: Alternate URL for f5-cloud-libs package. If not specified, the default GitHub location for f5-cloud-libs will be used. If version is different from default f5_cloudlibs_tag, ensure that hashes are valid by either updating scripts/verifyHash or by providing a f5_cloudlibs_verify_hash_url_override value. If version is different from default f5_cloudlibs_tag, ensure that hashes are valid by either updating scripts/verifyHash or by providing a f5_cloudlibs_verify_hash_url_override value.
    default: None
  f5_cloudlibs_verify_hash_url_override:
    type: string
    label: f5 cloud-libs verifyHash URL Override
    description: Alternate URL for verifyHash used to validate f5-cloud-libs package. If not specified, the scripts/verifyHash will be used.
    default: None
  f5_cloudlibs_openstack_tag:
    type: string
    label: f5-cloud-libs-openstack Tag
    description: Tag that determines version of f5 cloudlibs-package to use for provisioning. If specified, ensure that hashes are valid by either updating scripts/verifyHash or by providing a f5_cloudlibs_verify_hash_url_override value.
    default: v1.0.0
  f5_cloudlibs_openstack_url_override:
    type: string
    label: f5-cloud-libs-openstack URL Override
    description: Alternate URL for f5-cloud-libs-openstack package. If not specified, the default GitHub location for f5-cloud-libs will be used. If version is different from default f5_cloudlibs_tag, ensure that hashes are valid by either updating scripts/verifyHash or by providing a f5_cloudlibs_verify_hash_url_override value.
    default: None
  bigip_servers_ntp:
    type: comma_delimited_list
    label: f5 BIG-IP VE NTP servers
    description: A list of NTP servers to configure on the BIG-IP.
    default:
      - 0.us.pool.ntp.org
      - 1.us.pool.ntp.org
  bigip_servers_dns:
    type: comma_delimited_list
    label: f5 BIG-IP VE Domain Name Servers
    description: A list of DNS servers to configure on the BIG-IP.
    default:
      -
  allow_usage_analytics:
    type: boolean
    label: Allow Usage Analytics
    description: Toggles whether non-identifiable statistical information is sent to F5.
    default: true

  # bigip nnic provisioning
  bigip_nic_count:
    type: number
    label: f5 BIG-IP NIC count
    description: Number of additional NICs to attach to the BIG-IP. Note - exclude management nic from count.
    constraints:
      - range: {min: 1, max: 10}

  # bigip credentials
  bigip_os_ssh_key:
    type: string
    label: f5 BIG-IP VE Root SSH Key Name
    description: Name of key-pair to be installed on the BIG-IP VE instance to allow root SSH access.
    constraints:
      - custom_constraint: nova.keypair
  bigip_admin_pwd:
    type: string
    label: f5 BIG-IP VE Admin User Password
    description: Password for the BIG-IP admin user.
    hidden: true
  bigip_root_pwd:
    type: string
    label: f5 BIG-IP VE Root User Password
    description: Password for the BIG-IP root user.
    hidden: true

  # bigip licensing
  bigip_license_key_master:
    type: string
    label: Master Primary BIG-IP VE License Base Key
    description: f5 BIG-IP License Base Key.
    default: None
  bigip_addon_license_keys_master:
    type: comma_delimited_list
    label: Master Additional BIG-IP VE License Keys
    description: f5 BIG-IP License Add-On Keys.
    default:
      -
  bigip_license_key_slave:
    type: string
    label: Slave Primary BIG-IP VE License Base Key
    description: f5 BIG-IP License Base Key.
    default: None
  bigip_addon_license_keys_slave:
    type: comma_delimited_list
    label: Slave Additional BIG-IP VE License Keys
    description: f5 BIG-IP License Add-On Keys.
    default:
      -
  bigip_modules:
    type: comma_delimited_list
    label: Modules to provision on the BIG-IP.
    description: A list modules to provision and their level. <module_name:level>
    default:
      - ltm:nominal

  # os network
  external_network:
    type: string
    label: External Network Name
    description: Name of external network where floating IP resides.
    constraints:
      - custom_constraint: neutron.network
  mgmt_network:
    type: string
    label: Management Network
    description: Network to which the BIG-IP management interface is attached.
    constraints:
      - custom_constraint: neutron.network
  mgmt_mtu:
    type: number
    label: Management Interface MTU
    description: Network MTU for the BIG-IP management interface.
    default: 1400
  mgmt_security_group_name:
    type: string
    label: Management Security Group Name
    description: Name to apply on the security group for the BIG-IP management network.
  network_vlan_security_group_rules:
    type: json
    label: Security Group Rules
    description: The rules to apply to the security group
  network_vlan_names:
    type: comma_delimited_list
    label: OS Neutron Network to map to the BIG-IP VLAN
    description: The Neutron Networks for the corresponding BIG-IP VLANs.
    constraints:
  network_vlan_subnets:
    type: comma_delimited_list
    label: OS Neutron Subnet to map to the BIG-IP VLAN
    description: The Neutron Subnet for the corresponding BIG-IP VLANs.
    constraints:

  # bigip network
  bigip_default_gateway:
    type: string
    label: Default Gateway IP
    description: Upstream Gateway IP Address for BIG-IP instance.
    default: None
  bigip_mgmt_port:
    type: number
    label: Management port
    description: Port for the BIG-IP Management uri
    default: 443
  bigip_vlan_names:
    type: comma_delimited_list
    label: f5 BIG-IP VE VLAN names
    description: Names of the VLAN to be created on the BIG-IP.
    default:
      -
  bigip_vlan_mtus:
    type: comma_delimited_list
    label: f5 BIG-IP VE VLAN MTUs
    description: MTU value of the VLAN on the BIG-IP.
  bigip_vlan_tags:
    type: comma_delimited_list
    label: f5 BIG-IP VE VLAN tags
    description: Tags to apply on the VLAN on the BIG-IP. Use default value "None" for untagged.
    default: None
  bigip_self_port_lockdowns:
    type: comma_delimited_list
    label: f5 BIG-IP VE VLAN Allow Services
    description: Optional list with each item a list of <service:port> lockdown settings for the VLAN. If no value is supplied, default is used. Each list item corresponds to the settings for each NIC at that index.
    default:
      -

parameter_groups:
  - label: BIG-IP General Provisioning
    parameters:
      - bigip_image
      - bigip_flavor
      - bigip_cluster_name
      - bigip_cluster_sync_type
      - bigip_cluster_auto_sync
      - bigip_cluster_save_on_auto_sync
      - use_config_drive
      - f5_cloudlibs_tag
      - f5_cloudlibs_url_override
      - f5_cloudlibs_verify_hash_url_override
      - f5_cloudlibs_openstack_tag
      - f5_cloudlibs_openstack_url_override
      - bigip_servers_ntp
      - bigip_servers_dns
      - allow_usage_analytics
  - label: BIG-IP nNIC Provisioning
    parameters:
      - bigip_nic_count
  - label: BIG-IP Credentials
    parameters:
      - bigip_os_ssh_key
      - bigip_admin_pwd
      - bigip_root_pwd
  - label: BIG-IP Licensing and Modules
    parameters:
      - bigip_license_key_master
      - bigip_addon_license_keys_master
      - bigip_license_key_slave
      - bigip_addon_license_keys_slave
      - bigip_modules
  - label: OS Network
    parameters:
      - external_network
      - mgmt_network
      - mgmt_mtu
      - mgmt_security_group_name
      - network_vlan_security_group_rules
      - network_vlan_names
      - network_vlan_subnets
  - label: BIG-IP Network
    parameters:
      - bigip_default_gateway
      - bigip_mgmt_port
      - bigip_vlan_names
      - bigip_vlan_mtus
      - bigip_vlan_tags
      - bigip_self_port_lockdowns

resources:
  wait_condition_static_mgmt_config_complete_master:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_static_mgmt_config_master}
      count: 1
      timeout: 600
  wait_handle_static_mgmt_config_master:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_complete_master:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_master}
      count: 3
      timeout: 1800
  wait_handle_onboard_master:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_network_complete_master:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_network_master}
      count: 1
      timeout: 1800
  wait_handle_onboard_network_master:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_cluster_complete_master:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_cluster_master}
      count: 1
      timeout: 1800
  wait_handle_onboard_cluster_master:
    type: OS::Heat::WaitConditionHandle
  wait_condition_static_mgmt_config_complete_slave:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_static_mgmt_config_slave}
      count: 1
      timeout: 600
  wait_handle_static_mgmt_config_slave:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_complete_slave:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_slave}
      count: 3
      timeout: 1800
  wait_handle_onboard_slave:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_network_complete_slave:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_network_slave}
      count: 1
      timeout: 1800
  wait_handle_onboard_network_slave:
    type: OS::Heat::WaitConditionHandle
  wait_condition_onboard_cluster_complete_slave:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle_onboard_cluster_slave}
      count: 1
      timeout: 1800
  wait_handle_onboard_cluster_slave:
    type: OS::Heat::WaitConditionHandle
  mgmt_security_group:
    type: F5::BigIP::ManagementSecurityGroup
    properties:
      security_group_name: {get_param: mgmt_security_group_name}
      management_port: {get_param: bigip_mgmt_port}
  mgmt_port_master:
    type: OS::Neutron::Port
    properties:
      network: {get_param: mgmt_network}
      allowed_address_pairs:
        - ip_address: 0.0.0.0/0
        - ip_address: ::/0
      security_groups: [{get_attr: [mgmt_security_group, mgmt_security_group_id]}]
  floating_ip_master:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: {get_param: external_network}
      port_id: {get_resource: mgmt_port_master}
  bigip_nnic_handler_master:
    type: F5::BigIP::NNicHandlerSingleFixedIP
    properties:
      bigip_nic_count: {get_param: bigip_nic_count}
      network_vlan_names: {get_param: network_vlan_names}
      network_vlan_subnets: {get_param: network_vlan_subnets}
      network_vlan_security_group_rules: {get_param: network_vlan_security_group_rules}
      bigip_vlan_names: {get_param: bigip_vlan_names}
      bigip_vlan_tags: {get_param: bigip_vlan_tags}
      bigip_vlan_mtus: {get_param: bigip_vlan_mtus}
      bigip_self_port_lockdowns: {get_param: bigip_self_port_lockdowns}
      bigip_default_gateway: {get_param: bigip_default_gateway}
  environment_variables_master:
    type: F5::BigIP::EnvironmentVariables
    properties:
      os_wait_condition_static_mgmt: {get_attr: [wait_handle_static_mgmt_config_master, curl_cli]}
      os_wait_condition_onboard_network: {get_attr: [wait_handle_onboard_network_master, curl_cli]}
      os_wait_condition_onboard_complete: {get_attr: [wait_handle_onboard_master, curl_cli]}
      os_wait_condition_onboard_cluster_complete: {get_attr: [wait_handle_onboard_cluster_master, curl_cli]}
      os_management_port_id: { get_resource: mgmt_port_master }
      os_ssh_key_name: { get_param: bigip_os_ssh_key }
      os_use_config_drive: { get_param: use_config_drive }
      bigip_mgmt_interface_name: mgmt
      bigip_mgmt_mtu: {get_param: mgmt_mtu}
      bigip_mgmt_ip_address: { get_attr: [mgmt_port_master, fixed_ips, 0, ip_address] }
      bigip_mgmt_cidr: { get_attr: [mgmt_port_master, subnets, 0, cidr] }
      bigip_mgmt_gateway: { get_attr: [mgmt_port_master, subnets, 0, gateway_ip] }
      bigip_mgmt_dns_nameservers: { get_attr: [mgmt_port_master, subnets, 0, dns_nameservers] }
      bigip_host_name: { get_attr: [mgmt_port_master, show, dns_assignment, 0, fqdn] }
      bigip_management_port: { get_param: bigip_mgmt_port }
      bigip_nic_count: {get_param: bigip_nic_count}
      bigip_default_gateway: {get_param: bigip_default_gateway}
      bigip_servers_ntp: { get_param: bigip_servers_ntp }
      bigip_servers_dns: { get_param: bigip_servers_dns }
      bigip_vlan_creates: 
        repeat:
          template: "True"
          for_each:
            vlan: { get_param: bigip_vlan_names }
      bigip_vlan_names: {get_param: bigip_vlan_names}
      bigip_vlan_mtus: {get_param: bigip_vlan_mtus}
      bigip_vlan_tags: {get_param: bigip_vlan_tags}
      bigip_self_ip_addrs: {get_attr: [bigip_nnic_handler_master, bigip_selfips]}
      bigip_self_cidrs: {get_attr: [bigip_nnic_handler_master, bigip_selfip_cidrs]}
      bigip_self_port_lockdowns: {get_param: bigip_self_port_lockdowns}
      bigip_license_key: { get_param: bigip_license_key_master }
      bigip_addon_license_keys: { get_param: bigip_addon_license_keys_master }
      bigip_modules: { get_param: bigip_modules }      
      bigiq_use_alt_bigip_mgmt_ip: False
      bigiq_alt_bigip_mgmt_ip: None
      bigiq_alt_bigip_mgmt_port: 0
      bigiq_license_host_ip: None
      bigiq_license_username: None
      bigiq_license_pwd: None
      bigiq_license_pool: None
      bigip_master_mgmt_ip_address: { get_attr: [mgmt_port_master, fixed_ips, 0, ip_address] }
      bigip_device_group: {get_param: bigip_cluster_name}
      bigip_sync_type: {get_param: bigip_cluster_sync_type}
      bigip_auto_sync: {get_param: bigip_cluster_auto_sync}
      bigip_save_on_auto_sync: {get_param: bigip_cluster_save_on_auto_sync}
      bigip_config_sync_ip: {get_attr: [bigip_nnic_handler_master, bigip_selfips, 0]}    
      f5_cloudlibs_tag: { get_param: f5_cloudlibs_tag }
      f5_cloudlibs_url_override: { get_param: f5_cloudlibs_url_override }
      f5_cloudlibs_os_tag: { get_param: f5_cloudlibs_openstack_tag }
      f5_cloudlibs_os_url_override: { get_param: f5_cloudlibs_openstack_url_override }
      f5_ua_allow: { get_param: allow_usage_analytics }
      f5_ua_template_name: exp-f5_bigip_standalone_n_nic.yaml
      f5_ua_template_version: 3.0.0
      f5_ua_cloudlibs_tag: { get_param: f5_cloudlibs_tag }
      f5_ua_project_id: { get_param: 'OS::project_id'}
      f5_ua_region: None
      f5_ua_stack_id: { get_param: 'OS::stack_id' }
      f5_ua_license_type: None
      f5_verify_hash_url_override: { get_param: f5_cloudlibs_verify_hash_url_override }
      f5_keep_admin: False
      f5_keep_bigiq: False
      f5_keep_config_drive: False
  mgmt_port_slave:
    type: OS::Neutron::Port
    properties:
      network: {get_param: mgmt_network}
      allowed_address_pairs:
        - ip_address: 0.0.0.0/0
        - ip_address: ::/0
      security_groups: [{get_attr: [mgmt_security_group, mgmt_security_group_id]}]
  floating_ip_slave:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: {get_param: external_network}
      port_id: {get_resource: mgmt_port_slave}
  bigip_nnic_handler_slave:
    type: F5::BigIP::NNicHandler
    properties:
      bigip_nic_count: {get_param: bigip_nic_count}
      network_vlan_names: {get_param: network_vlan_names}
      network_vlan_subnets: {get_param: network_vlan_subnets}
      network_vlan_security_group_rules: {get_param: network_vlan_security_group_rules}
      bigip_vlan_names: {get_param: bigip_vlan_names}
      bigip_vlan_tags: {get_param: bigip_vlan_tags}
      bigip_vlan_mtus: {get_param: bigip_vlan_mtus}
      bigip_self_port_lockdowns: {get_param: bigip_self_port_lockdowns}
      bigip_default_gateway: {get_param: bigip_default_gateway}
  environment_variables_slave:
    type: F5::BigIP::EnvironmentVariables
    properties:
      os_wait_condition_static_mgmt: {get_attr: [wait_handle_static_mgmt_config_slave, curl_cli]}
      os_wait_condition_onboard_network: {get_attr: [wait_handle_onboard_network_slave, curl_cli]}
      os_wait_condition_onboard_complete: {get_attr: [wait_handle_onboard_slave, curl_cli]}
      os_wait_condition_onboard_cluster_complete: {get_attr: [wait_handle_onboard_cluster_slave, curl_cli]}
      os_management_port_id: { get_resource: mgmt_port_slave }
      os_ssh_key_name: { get_param: bigip_os_ssh_key }
      os_use_config_drive: { get_param: use_config_drive }
      bigip_mgmt_interface_name: mgmt
      bigip_mgmt_mtu: {get_param: mgmt_mtu}
      bigip_mgmt_ip_address: { get_attr: [mgmt_port_slave, fixed_ips, 0, ip_address] }
      bigip_mgmt_cidr: { get_attr: [mgmt_port_slave, subnets, 0, cidr] }
      bigip_mgmt_gateway: { get_attr: [mgmt_port_slave, subnets, 0, gateway_ip] }
      bigip_mgmt_dns_nameservers: { get_attr: [mgmt_port_slave, subnets, 0, dns_nameservers] }
      bigip_host_name: { get_attr: [mgmt_port_slave, show, dns_assignment, 0, fqdn] }
      bigip_management_port: { get_param: bigip_mgmt_port }
      bigip_nic_count: {get_param: bigip_nic_count}
      bigip_default_gateway: {get_param: bigip_default_gateway}
      bigip_servers_ntp: { get_param: bigip_servers_ntp }
      bigip_servers_dns: { get_param: bigip_servers_dns }
      bigip_vlan_creates: 
        repeat:
          template: "True"
          for_each:
            vlan: { get_param: bigip_vlan_names }
      bigip_vlan_names: {get_param: bigip_vlan_names}
      bigip_vlan_mtus: {get_param: bigip_vlan_mtus}
      bigip_vlan_tags: {get_param: bigip_vlan_tags}
      bigip_self_ip_addrs: {get_attr: [bigip_nnic_handler_slave, bigip_selfips]}
      bigip_self_cidrs: {get_attr: [bigip_nnic_handler_slave, bigip_selfip_cidrs]}
      bigip_self_port_lockdowns: {get_param: bigip_self_port_lockdowns}
      bigip_license_key: { get_param: bigip_license_key_slave }
      bigip_addon_license_keys: { get_param: bigip_addon_license_keys_slave }
      bigip_modules: { get_param: bigip_modules }      
      bigiq_use_alt_bigip_mgmt_ip: False
      bigiq_alt_bigip_mgmt_ip: None
      bigiq_alt_bigip_mgmt_port: 0
      bigiq_license_host_ip: None
      bigiq_license_username: None
      bigiq_license_pwd: None
      bigiq_license_pool: None
      bigip_master_mgmt_ip_address: { get_attr: [mgmt_port_master, fixed_ips, 0, ip_address] }
      bigip_device_group: {get_param: bigip_cluster_name}
      bigip_sync_type: {get_param: bigip_cluster_sync_type}
      bigip_auto_sync: {get_param: bigip_cluster_auto_sync}
      bigip_save_on_auto_sync: {get_param: bigip_cluster_save_on_auto_sync}
      bigip_config_sync_ip: {get_attr: [bigip_nnic_handler_slave, bigip_selfips, 0]}    
      f5_cloudlibs_tag: { get_param: f5_cloudlibs_tag }
      f5_cloudlibs_url_override: { get_param: f5_cloudlibs_url_override }
      f5_cloudlibs_os_tag: { get_param: f5_cloudlibs_openstack_tag }
      f5_cloudlibs_os_url_override: { get_param: f5_cloudlibs_openstack_url_override }
      f5_ua_allow: { get_param: allow_usage_analytics }
      f5_ua_template_name: exp-f5_bigip_standalone_n_nic.yaml
      f5_ua_template_version: 3.0.0
      f5_ua_cloudlibs_tag: { get_param: f5_cloudlibs_tag }
      f5_ua_project_id: { get_param: 'OS::project_id'}
      f5_ua_region: None
      f5_ua_stack_id: { get_param: 'OS::stack_id' }
      f5_ua_license_type: None
      f5_verify_hash_url_override: { get_param: f5_cloudlibs_verify_hash_url_override }
      f5_keep_admin: False
      f5_keep_bigiq: False
      f5_keep_config_drive: False
  init_0_static_mgmt_config:
    type: F5::BigIP::StaticMgmtConfig
  init_1_override_default_config:
    type: F5::BigIP::OverrideDefaultConfig
    properties:
      admin_password: {get_param: bigip_admin_pwd}
      root_password: {get_param: bigip_root_pwd}
  init_2_onboard_libs:
    type: F5::BigIP::OnboardingLibs
  init_3_onboard_scripts:
    type: F5::BigIP::OnboardingScripts
  init_4_onboard_network_config:
    type: F5::BigIP::OnboardNetworkConfigNNic
  init_5_onboard_cluster_config:
    type: F5::BigIP::OnboardClusterConfig
  init_6_run_cluster_core_commands_static_mgmt:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        merge_how: dict(recurse_array,no_replace)+list(append)
        runcmd:
          - nohup sh -c '/config/wait-staticMgmtConfig.sh; /config/download-cloudlibs.sh' &>> /var/log/download-cloudlibs.log< /dev/null &
          - nohup sh -c '/config/wait-cloudlibsDownload.sh; /config/preOnboard.sh' &>> /var/log/preOnboard.log < /dev/null &
          - nohup sh -c '/config/wait-cloudlibsInstall.sh; /config/onboard.sh' >> /var/log/onboard.log < /dev/null &
          - nohup sh -c '/config/wait-cloudlibsInstall.sh; f5-rest-node /config/cloud/openstack/node_modules/f5-cloud-libs/scripts/runScript.js --file /config/onboard-network.sh --wait-for ONBOARD_DONE --signal ONBOARD_NETWORK_DONE  -o /var/log/onboard-network.log' &>> /var/log/runScript.log < /dev/null &
          - nohup sh -c '/config/wait-cloudlibsInstall.sh; f5-rest-node /config/cloud/openstack/node_modules/f5-cloud-libs/scripts/runScript.js --file /config/onboard-cluster.sh --wait-for ONBOARD_NETWORK_DONE --signal ONBOARD_CLUSTER_DONE' &>> /var/log/runScript.log < /dev/null &
          - nohup sh -c '/config/wait-cloudlibsInstall.sh; f5-rest-node /config/cloud/openstack/node_modules/f5-cloud-libs/scripts/runScript.js --file /config/postOnboard.sh --wait-for ONBOARD_CLUSTER_DONE -o /var/log/postOnboard.log' &>> /var/log/runScript.log < /dev/null &  
  bigip_provision_master:
    type: OS::Heat::MultipartMime
    properties:
      parts:
        repeat:
          template:
            config: <%config%>
          for_each:
            <%config%>:
              str_split:
                - ','
                -
                  list_join:
                    - ','
                    - [{get_resource: environment_variables_master}]
                    - [{get_resource: init_0_static_mgmt_config}]
                    - [{get_resource: init_1_override_default_config}]
                    - [{get_resource: init_2_onboard_libs}]
                    - [{get_resource: init_3_onboard_scripts}]
                    - [{get_resource: init_4_onboard_network_config}]
                    - [{get_resource: init_5_onboard_cluster_config}] 
                    - [{get_resource: init_6_run_cluster_core_commands_static_mgmt}]              
  bigip_provision_slave:
    type: OS::Heat::MultipartMime
    properties:
      parts:
        repeat:
          template:
            config: <%config%>
          for_each:
            <%config%>:
              str_split:
                - ','
                -
                  list_join:
                    - ','
                    - [{get_resource: environment_variables_slave}]
                    - [{get_resource: init_0_static_mgmt_config}]
                    - [{get_resource: init_1_override_default_config}]
                    - [{get_resource: init_2_onboard_libs}]
                    - [{get_resource: init_3_onboard_scripts}]
                    - [{get_resource: init_4_onboard_network_config}]
                    - [{get_resource: init_5_onboard_cluster_config}]
                    - [{get_resource: init_6_run_cluster_core_commands_static_mgmt}]
  bigip_instance_master:
    type: OS::Nova::Server
    depends_on: bigip_nnic_handler_master
    properties:
      image: {get_param: bigip_image}
      flavor: {get_param: bigip_flavor}
      key_name: {get_param: bigip_os_ssh_key}
      admin_user: root
      config_drive: {get_param: use_config_drive}
      networks:
        repeat:
          template:
            port: <%port%>
          for_each:
            <%port%>:
              str_split:
                - ','
                -
                  list_join:
                    - ','
                    - [{get_resource: mgmt_port_master}]
                    - {get_attr: [bigip_nnic_handler_master, port_ids]}
      user_data_format: RAW
      user_data: {get_resource: bigip_provision_master}
  bigip_instance_slave:
    type: OS::Nova::Server
    depends_on: bigip_nnic_handler_slave
    properties:
      image: {get_param: bigip_image}
      flavor: {get_param: bigip_flavor}
      key_name: {get_param: bigip_os_ssh_key}
      admin_user: root
      config_drive: {get_param: use_config_drive}
      networks:
        repeat:
          template:
            port: <%port%>
          for_each:
            <%port%>:
              str_split:
                - ','
                -
                  list_join:
                    - ','
                    - [{get_resource: mgmt_port_slave}]
                    - {get_attr: [bigip_nnic_handler_slave, port_ids]}
      user_data_format: RAW
      user_data: {get_resource: bigip_provision_slave}

outputs:
  bigip_instance_id_master:
    description: ID of the BIG-IP instance
    value: {get_resource: bigip_instance_master}
  bigip_instance_name_master:
    description: Name of the BIG-IP instance
    value: {get_attr: [bigip_instance_master, name]}
  floating_ip_master:
    description: The Floating IP address of the BIG-IP instance
    value: {get_attr: [floating_ip_master, floating_ip_address]}
  mgmt_ip_master:
    description: The mgmt IP address of BIG-IP instance
    value: {get_attr: [mgmt_port_master, fixed_ips, 0, ip_address]}
  mgmt_mac_master:
    description: The mgmt MAC address of BIG-IP instance
    value: {get_attr: [mgmt_port_master, mac_address]}
  mgmt_port_id_master:
    description: The port id of the BIG-IP mgmt interface
    value: {get_resource: mgmt_port_master}
  data_port_ids_master:
    description: The port ids of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_master, port_ids]}
  data_fixed_ips_master:
    description: The fixed_ips for the port of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_master, port_fixed_ips]}
  data_fixed_subnets_master:
    description: The port ids of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_master, port_subnets]}
  bigip_instance_id_slave:
    description: ID of the BIG-IP instance
    value: {get_resource: bigip_instance_slave}
  bigip_instance_name_slave:
    description: Name of the BIG-IP instance
    value: {get_attr: [bigip_instance_slave, name]}
  floating_ip_slave:
    description: The Floating IP address of the BIG-IP instance
    value: {get_attr: [floating_ip_slave, floating_ip_address]}
  mgmt_ip_slave:
    description: The mgmt IP address of BIG-IP instance
    value: {get_attr: [mgmt_port_slave, fixed_ips, 0, ip_address]}
  mgmt_mac_slave:
    description: The mgmt MAC address of BIG-IP instance
    value: {get_attr: [mgmt_port_slave, mac_address]}
  mgmt_port_id_slave:
    description: The port id of the BIG-IP mgmt interface
    value: {get_resource: mgmt_port_slave}
  data_port_ids_slave:
    description: The port ids of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_slave, port_ids]}
  data_fixed_ips_slave:
    description: The fixed_ips for the port of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_slave, port_fixed_ips]}
  data_fixed_subnets_slave:
    description: The port ids of the TMM interfaces
    value: {get_attr: [bigip_nnic_handler_slave, port_subnets]}
